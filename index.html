<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>7AYA GAME</title>

  <link rel="apple-touch-icon" href="IMG_0383.jpeg">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="7AYA-GAME">
  <meta name="theme-color" content="#0d0d0d"/>

  <style>
    :root {
      --primary: #00c6ff;
      --secondary: #0072ff;
      --bg: #0d0d0d;
      --card-bg: #1a1a1a;
      --text: #ffffff;
      --gray: #888;
      --danger: #ff4d4d;
      --success: #00e676;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      margin: 0; padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      height: 100%; width: 100%;
      overflow-x: hidden;
    }

    body { display: flex; flex-direction: column; padding-bottom: 90px; }

    h2, h3 { margin: 10px 0; font-weight: 600; }
    p { margin: 5px 0; font-size: 0.95rem; color: #ddd; }

    .container { padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }
    .hidden { display: none !important; }

    .card {
      background: var(--card-bg);
      padding: 18px;
      border-radius: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      border: 1px solid #2a2a2a;
    }

    .wallet-card {
      background: linear-gradient(135deg, #1e1e1e 0%, #111 100%);
      border-left: 4px solid var(--primary);
    }

    input, select, button {
      font-size: 1rem; padding: 14px; margin: 8px 0;
      width: 100%; border-radius: 12px; border: none; outline: none; transition: 0.3s;
    }

    input, select { background: #252525; color: white; border: 1px solid #333; }
    
    button {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white; font-weight: bold; text-transform: uppercase; cursor: pointer;
    }

    button.secondary { background: #333; border: 1px solid #444; }
    button:active { transform: scale(0.96); opacity: 0.9; }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: 75px;
      background: #151515; display: flex; justify-content: space-around;
      align-items: center; border-top: 1px solid #333; z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .nav-item { color: var(--gray); font-size: 12px; text-align: center; flex: 1; }
    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-item i { display: block; font-size: 22px; margin-bottom: 4px; }

    /* Bill Styling */
    .bill-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px; border-bottom: 1px solid #333;
    }
    .bill-unpaid { border-left: 4px solid var(--danger); }
    .bill-paid { border-left: 4px solid var(--success); opacity: 0.7; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .tab-content { animation: fadeIn 0.3s ease-out; }
  </style>
</head>
<body>

<div id="auth-container" class="container">
    <div style="text-align:center; margin-top: 50px;">
        <h1 style="color: var(--primary); font-size: 3.5rem; margin-bottom: 0;">7AYA</h1>
        <p style="color: var(--gray); margin-bottom: 30px;">Digital Life Simulator</p>
    </div>

    <div id="login-box" class="card">
        <h2>Login</h2>
        <input id="username" placeholder="Username" autocomplete="off" />
        <input id="pin" placeholder="PIN" type="password" maxlength="6" />
        <button onclick="login()">Enter Game</button>
        <p style="text-align:center; margin-top:15px; font-size: 0.8rem;">
            Don't have an account? <span onclick="toggleAuth(true)" style="color:var(--primary); font-weight:bold;">Create one</span>
        </p>
    </div>

    <div id="signup-box" class="card hidden">
        <h2>Create Account</h2>
        <input id="new-username" placeholder="Choose Username" autocomplete="off" />
        <input id="new-pin" placeholder="Set 6-digit PIN" type="password" maxlength="6" />
        <button onclick="signup()">Join 7AYA</button>
        <p style="text-align:center; margin-top:15px; font-size: 0.8rem;">
            Already a member? <span onclick="toggleAuth(false)" style="color:var(--primary); font-weight:bold;">Login</span>
        </p>
    </div>
</div>

<div id="main" class="hidden">
  
  <div class="container" style="padding-bottom: 0;">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2 id="welcome" style="font-size: 1.1rem; color: var(--primary);">Loading...</h2>
        <button onclick="logout()" style="width: auto; padding: 6px 15px; font-size: 0.7rem; background: #333;">LOGOUT</button>
    </div>
    <div class="card" style="margin-top: 10px; padding: 12px; text-align: center;">
        <span id="gameTime" style="font-family: monospace; font-size: 1.3rem; letter-spacing: 2px;">--:--:--</span>
    </div>
  </div>

  <div id="tab-dashboard" class="tab-content container">
    <div class="card wallet-card">
        <p style="color: var(--gray); text-transform: uppercase; font-size: 0.7rem; font-weight: bold;">Balance</p>
        <h1 style="margin: 5px 0; font-size: 2.5rem;"><span id="money">0</span> <small style="font-size: 1rem; color: var(--gray);">EGP</small></h1>
        <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
        <p>üìû <span id="phone" style="font-weight: bold;">--</span></p>
        <p>üåê Internet: <span id="internet" style="color:var(--primary); font-weight: bold;">0</span> MB</p>
    </div>

    <button onclick="prepareSound(); startQrMoneyTransfer()">üí∏ Transfer Money</button>
    <div id="scannerContainer">
        <div id="scanner" style="width: 100%; display: none;"></div>
        <div id="qrStatus" style="text-align:center; color: var(--primary); margin-top: 5px;"></div>
    </div>

    <div class="card">
        <h3>üé¥ ID Card</h3>
        <input id="cardPin" placeholder="New Card PIN (3 digits)" maxlength="3" />
        <button onclick="makeCard()" class="secondary">Issue Digital Card</button>
        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
            <input id="openCardPin" placeholder="Enter Card PIN" maxlength="3" />
            <button onclick="openCard()">View Card</button>
        </div>
        <div id="cardView" class="card hidden" style="background: #111; border: 1px solid var(--primary);"></div>
    </div>
  </div>

  <div id="tab-telecom" class="tab-content container hidden">
    <h3>üì± Telecom Store</h3>
    <div class="card">
        <p>Buy Number (250 EGP)</p>
        <select id="company">
            <option value="">Select Operator</option>
            <option value="Orange">Orange</option>
            <option value="Vodafone">Vodafone</option>
            <option value="e&">e&</option>
        </select>
        <button onclick="buyNumber()">Get SIM</button>
    </div>

    <div id="simApp" class="hidden">
        <div class="card">
            <h4>SIM: <span id="simCompany" style="color:var(--primary)"></span></h4>
            <button onclick="buyBundle(40, 1500)">1.5GB - 40 EGP</button>
            <button onclick="buyBundle(60, 2250)">2.2GB - 60 EGP</button>
            <button onclick="buyBundle(80, 4250)">4.2GB - 80 EGP</button>
        </div>
    </div>
  </div>

  <div id="tab-social" class="tab-content container hidden">
    <h3>üåç Facenet</h3>
    <div class="card">
        <input id="postTitle" placeholder="Write something..." />
        <div style="display:flex; gap: 10px;">
            <input id="postImage" type="file" accept="image/*,video/*" style="font-size: 0.7rem;"/>
            <button onclick="makePost()" style="width:100px;">POST</button>
        </div>
    </div>
    <div id="facenetPosts"></div>
  </div>

  <div id="tab-extras" class="tab-content container hidden">
    <h3>üßæ My Bills</h3>
    <div id="billList" class="card">
        <p style="text-align:center; color:var(--gray);">No active bills</p>
    </div>

    <div class="card" style="margin-top:30px; border: 1px dashed #444;">
        <h4>Admin Panel</h4>
        <input id="adminCode" placeholder="Enter Access Code" type="password" />
        <button onclick="unlockAdmin()" class="secondary">Unlock Tools</button>

        <div id="adminPanel" class="hidden" style="margin-top:20px; border-top: 1px solid #444; padding-top:15px;">
            <p style="color:var(--primary); font-weight:bold;">Issue New Bill</p>
            <select id="adminUserList">
                <option value="">Select User</option>
            </select>
            <input id="adminBillTitle" placeholder="Bill Title (e.g. Electric)" />
            <input id="adminBillAmount" type="number" placeholder="Amount (EGP)" />
            <button onclick="adminIssueBill()">Send Bill</button>
        </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="showTab('dashboard', this)"><i>üè†</i>Wallet</div>
    <div class="nav-item" onclick="showTab('telecom', this)"><i>üì∂</i>SIM</div>
    <div class="nav-item" onclick="showTab('social', this)"><i>üåê</i>Social</div>
    <div class="nav-item" onclick="showTab('extras', this)"><i>üßæ</i>More</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// --- FIREBASE INIT ---
const firebaseConfig = {
    apiKey: "AIzaSyD8LLjhoQEefz6dYdhSVbFOsIqvizO8WaY",
    authDomain: "aya-game-e579b.firebaseapp.com",
    databaseURL: "https://aya-game-e579b-default-rtdb.firebaseio.com",
    projectId: "aya-game-e579b",
    storageBucket: "aya-game-e579b.appspot.com",
    messagingSenderId: "425563173336",
    appId: "1:425563173336:web:4de74ff9fcd07d..."
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let serverOffsetMs = 0;
let soundReady = false;

// --- AUTH LOGIC ---
function toggleAuth(isSignup) {
    document.getElementById('login-box').classList.toggle('hidden', isSignup);
    document.getElementById('signup-box').classList.toggle('hidden', !isSignup);
}

function signup() {
    const user = document.getElementById('new-username').value.trim().toLowerCase();
    const pin = document.getElementById('new-pin').value.trim();
    if(user.length < 3 || pin.length < 3) return alert("Username/PIN too short");

    db.ref("users/" + user).once("value").then(snap => {
        if(snap.exists()) return alert("Username already taken");
        db.ref("users/" + user).set({
            pin: pin,
            money: 500, // Starting bonus
            internet: 0,
            raseed: 0
        }).then(() => {
            alert("Account created! Logging in...");
            currentUser = user;
            loadUser();
        });
    });
}

function login() {
    const user = document.getElementById("username").value.trim().toLowerCase();
    const pin = document.getElementById("pin").value.trim();
    db.ref("users/" + user).once("value").then(snap => {
        if (snap.exists() && snap.val().pin === pin) {
            currentUser = user;
            localStorage.setItem("7ayaUser", user);
            loadUser();
        } else { alert("Invalid User/PIN"); }
    });
}

function loadUser() {
    document.getElementById("auth-container").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");
    
    db.ref("users/" + currentUser).on("value", snap => {
        const data = snap.val();
        document.getElementById("money").textContent = data.money ?? 0;
        document.getElementById("phone").textContent = data.phone || "No Number";
        document.getElementById("internet").textContent = data.internet ?? 0;
        document.getElementById("welcome").textContent = `Hello, ${currentUser}`;
        if (data.company) {
            document.getElementById("simApp").classList.remove("hidden");
            document.getElementById("simCompany").textContent = data.company;
        }
    });
    
    startGameClock();
    loadPosts();
    loadMyBills();
    loadAllUsers(); // For admin
    setInterval(() => {
        db.ref(`users/${currentUser}/internet`).transaction(val => Math.max(0, (val || 0) - 20));
    }, 60000);
}

function logout() { localStorage.clear(); location.reload(); }

// --- TABS ---
function showTab(tabId, el) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById('tab-' + tabId).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    el.classList.add('active');
}

// --- BILLING SYSTEM ---
function loadMyBills() {
    db.ref(`users/${currentUser}/bills`).on("value", snap => {
        const list = document.getElementById("billList");
        list.innerHTML = "";
        if(!snap.exists()) {
            list.innerHTML = `<p style="text-align:center; color:var(--gray);">No active bills</p>`;
            return;
        }
        snap.forEach(child => {
            const b = child.val();
            const id = child.key;
            const div = document.createElement("div");
            div.className = `bill-item ${b.paid ? 'bill-paid' : 'bill-unpaid'}`;
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold;">${b.title}</div>
                    <div style="font-size:0.8rem; color:var(--gray);">${b.amount} EGP</div>
                </div>
                ${!b.paid ? `<button onclick="payBill('${id}', ${b.amount})" style="width:70px; padding:8px; font-size:0.7rem;">Pay</button>` : '<span>Paid</span>'}
            `;
            list.prepend(div);
        });
    });
}

function payBill(id, amt) {
    db.ref(`users/${currentUser}`).once("value").then(snap => {
        const m = snap.val().money || 0;
        if(m < amt) return alert("Not enough balance");
        db.ref(`users/${currentUser}/money`).set(m - amt);
        db.ref(`users/${currentUser}/bills/${id}/paid`).set(true);
    });
}

// --- ADMIN BILLING ---
function unlockAdmin() {
    if(document.getElementById("adminCode").value === "555") {
        document.getElementById("adminPanel").classList.remove("hidden");
    } else { alert("Access Denied"); }
}

function loadAllUsers() {
    db.ref("users").once("value").then(snap => {
        const select = document.getElementById("adminUserList");
        select.innerHTML = '<option value="">Select User</option>';
        snap.forEach(child => {
            const opt = document.createElement("option");
            opt.value = child.key;
            opt.textContent = child.key;
            select.appendChild(opt);
        });
    });
}

function adminIssueBill() {
    const target = document.getElementById("adminUserList").value;
    const title = document.getElementById("adminBillTitle").value;
    const amt = parseInt(document.getElementById("adminBillAmount").value);
    
    if(!target || !title || isNaN(amt)) return alert("Fill all fields");
    
    db.ref(`users/${target}/bills`).push({
        title: title,
        amount: amt,
        paid: false,
        issuedBy: currentUser
    }).then(() => {
        alert(`Bill sent to ${target}`);
        document.getElementById("adminBillTitle").value = "";
        document.getElementById("adminBillAmount").value = "";
    });
}

// --- SIM / INTERNET ---
function buyNumber() {
    const co = document.getElementById("company").value;
    if(!co) return alert("Select company");
    db.ref("users/"+currentUser).once("value").then(s => {
        if(s.val().money < 250) return alert("Need 250 EGP");
        db.ref("users/"+currentUser).update({
            money: s.val().money - 250,
            phone: "01" + Math.floor(100000000 + Math.random()*900000000),
            company: co
        });
    });
}

function buyBundle(cost, mb) {
    db.ref("users/"+currentUser).once("value").then(s => {
        if(s.val().money < cost) return alert("Low balance");
        db.ref("users/"+currentUser).update({
            money: s.val().money - cost,
            internet: (s.val().internet || 0) + mb
        });
        alert("Bundle Active");
    });
}

// --- UTILITIES (REUSED) ---
db.ref(".info/serverTimeOffset").on("value", snap => { serverOffsetMs = snap.val() || 0; });
function startGameClock() {
    const cycleMs = 12 * 60 * 1000; 
    const scale = (24 * 60 * 60 * 1000) / cycleMs;
    setInterval(() => {
        const v = ((Date.now() + serverOffsetMs) % cycleMs) * scale;
        const d = new Date(v);
        let h = d.getUTCHours();
        const m = String(d.getUTCMinutes()).padStart(2, "0");
        const ap = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        document.getElementById("gameTime").textContent = `${h}:${m} ${ap}`;
    }, 1000);
}

let qrScanner = null;
function prepareSound() {
    const audio = document.getElementById("successSound");
    audio.play().then(() => { audio.pause(); audio.currentTime = 0; soundReady = true; }).catch(() => {});
}

function startQrMoneyTransfer() {
    document.getElementById("scanner").style.display = "block";
    if (!qrScanner) qrScanner = new Html5Qrcode("scanner");
    Html5Qrcode.getCameras().then(devices => {
        const cam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        qrScanner.start(cam.id, { fps: 20, qrbox: 250 }, (data) => {
            qrScanner.stop().then(() => {
                document.getElementById("scanner").style.display = "none";
                const target = data.trim().toLowerCase();
                const amt = parseInt(prompt(`Send EGP to ${target}:`));
                if (isNaN(amt) || amt <= 0) return;
                db.ref("users/"+currentUser+"/money").transaction(c => {
                    if((c||0) >= amt) {
                        db.ref("users/"+target+"/money").transaction(r => (r||0) + amt);
                        if(soundReady) document.getElementById("successSound").play();
                        return c - amt;
                    } else { alert("Low funds"); return c; }
                });
            });
        });
    });
}

function makePost() {
    const t = document.getElementById("postTitle").value;
    const f = document.getElementById("postImage").files[0];
    if(!t || !f) return alert("Select title and file");
    const r = new FileReader();
    r.onload = (e) => {
        db.ref("posts").push({
            user: currentUser, title: t, url: e.target.result,
            mediaType: f.type.startsWith("video") ? "video" : "image"
        }).then(() => { document.getElementById("postTitle").value = ""; alert("Posted!"); });
    };
    r.readAsDataURL(f);
}

function loadPosts() {
    db.ref("posts").limitToLast(10).on("value", s => {
        const con = document.getElementById("facenetPosts");
        con.innerHTML = "";
        s.forEach(c => {
            const p = c.val();
            const div = document.createElement("div");
            div.style.borderBottom = "1px solid #333"; div.style.padding = "10px 0";
            const med = p.mediaType === "video" ? `<video src="${p.url}" controls style="width:100%"></video>` : `<img src="${p.url}" style="width:100%">`;
            div.innerHTML = `<strong>@${p.user}</strong><p>${p.title}</p>${med}`;
            con.prepend(div);
        });
    });
}

function makeCard() {
    const pin = document.getElementById("cardPin").value;
    if(pin.length !== 3) return alert("Need 3 digits");
    const n = `${Math.floor(1000+Math.random()*9000)} ${Math.floor(1000+Math.random()*9000)}`;
    db.ref(`users/${currentUser}/card`).set({ pin, number: n }).then(() => alert("Card Ready"));
}

function openCard() {
    const pin = document.getElementById("openCardPin").value;
    db.ref(`users/${currentUser}/card`).once("value").then(s => {
        const c = s.val();
        if (c && c.pin === pin) {
            document.getElementById("cardView").innerHTML = `<p><b>ID:</b> ${c.number}</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${currentUser}" style="width:120px;display:block;margin:auto">`;
            document.getElementById("cardView").classList.remove("hidden");
        } else { alert("Wrong PIN"); }
    });
}

window.onload = () => {
    const s = localStorage.getItem("7ayaUser");
    if(s) { currentUser = s; loadUser(); }
};
</script>

<audio id="successSound" src="https://audio.jukehost.co.uk/1aTbUcc5vRSDBHlwrgNMrAszF5BJ3Q8J" preload="auto"></audio>

</body>
</html>
