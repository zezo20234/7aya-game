<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>7AYA GAME</title>

  <link rel="apple-touch-icon" href="IMG_0383.jpeg">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="7AYA-GAME">
  <meta name="theme-color" content="#0d0d0d"/>

  <style>
    :root {
      --primary: #00c6ff;
      --secondary: #0072ff;
      --bg: #0d0d0d;
      --card-bg: #1a1a1a;
      --text: #ffffff;
      --gray: #888;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      margin: 0; padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      height: 100%; width: 100%;
      overflow-x: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      padding-bottom: 70px; /* Space for bottom nav */
    }

    /* Typography */
    h2, h3 { margin: 10px 0; font-weight: 600; letter-spacing: 0.5px; }
    p { margin: 5px 0; font-size: 0.95rem; color: #ddd; }

    /* Layout Containers */
    .container { padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }
    .hidden { display: none !important; }

    /* Cards */
    .card {
      background: var(--card-bg);
      padding: 18px;
      border-radius: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      border: 1px solid #2a2a2a;
    }

    .wallet-card {
      background: linear-gradient(135deg, #1e1e1e 0%, #111 100%);
      border-left: 4px solid var(--primary);
    }

    /* Inputs & Buttons */
    input, select, button {
      font-size: 1rem;
      padding: 14px;
      margin: 8px 0;
      width: 100%;
      border-radius: 12px;
      border: none;
      outline: none;
      transition: 0.3s;
    }

    input, select {
      background: #252525;
      color: white;
      border: 1px solid #333;
    }

    input:focus { border-color: var(--primary); }

    button {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
    }

    button:active { transform: scale(0.96); opacity: 0.9; }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 65px;
      background: #151515;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 1px solid #333;
      z-index: 1000;
    }

    .nav-item {
      color: var(--gray);
      font-size: 12px;
      text-align: center;
      flex: 1;
      padding: 10px 0;
    }

    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-item i { display: block; font-size: 20px; margin-bottom: 2px; }

    /* Facenet Styling */
    #facenetPosts img, #facenetPosts video {
      width: 100%;
      border-radius: 12px;
      margin: 10px 0;
    }

    .post-card { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }

    /* QR Scanner */
    #scanner { border-radius: 15px; overflow: hidden; background: #000; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .tab-content { animation: fadeIn 0.4s ease-out; }

  </style>
</head>
<body>

<div id="login" class="container">
  <div style="text-align:center; margin-top: 50px;">
     <h1 style="color: var(--primary); margin-bottom: 5px;">7AYA</h1>
     <p style="margin-bottom: 30px;">Digital Life Simulator</p>
  </div>
  <div class="card">
    <h2>Login</h2>
    <input id="username" placeholder="Username" autocomplete="off" />
    <input id="pin" placeholder="PIN" type="password" maxlength="6" />
    <label style="display:flex; align-items:center; gap:10px; margin: 10px 0;">
        <input type="checkbox" id="keepSigned" style="width:20px;"> Keep me signed in
    </label>
    <button onclick="login()">Enter Game</button>
  </div>
</div>

<div id="main" class="hidden">
  
  <div class="container" style="padding-bottom: 0;">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2 id="welcome" style="font-size: 1.1rem;">Welcome</h2>
        <button onclick="logout()" style="width: auto; padding: 5px 15px; font-size: 0.8rem; background: #333;">Logout</button>
    </div>
    <div class="card" style="margin-top: 10px; padding: 10px 15px; text-align: center; border: 1px dashed var(--primary);">
        <span id="gameTime" style="font-family: monospace; font-size: 1.2rem; color: var(--primary);">--:--:--</span>
    </div>
  </div>

  <div id="tab-dashboard" class="tab-content container">
    <div class="card wallet-card">
        <p style="color: var(--gray); text-transform: uppercase; font-size: 0.7rem; font-weight: bold;">Available Balance</p>
        <h1 style="margin: 5px 0;"><span id="money">0</span> <small style="font-size: 1rem;">EGP</small></h1>
        <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
        <p>üìû <span id="phone" style="color:#fff">--</span></p>
        <p>üì∂ Raseed: <span id="raseed" style="color:#fff">0</span> | Internet: <span id="internet" style="color:#fff">0</span> MB</p>
    </div>

    <button onclick="prepareSound(); startQrMoneyTransfer()">üí∏ Scan to Send Money</button>
    <div id="scannerContainer">
        <div id="scanner" style="width: 100%; display: none;"></div>
        <div id="qrStatus" style="text-align:center; color: var(--primary); margin-top: 5px;"></div>
    </div>

    <div class="card">
        <h3>üé¥ Digital Card</h3>
        <input id="cardPin" placeholder="New 3-digit PIN" maxlength="3" />
        <button onclick="makeCard()" style="background: #333;">Create Card</button>
        <div style="margin-top: 15px;">
            <input id="openCardPin" placeholder="Enter PIN to View" maxlength="3" />
            <button onclick="openCard()">View Card Info</button>
        </div>
        <div id="cardView" class="card hidden" style="background: #222; margin-top:10px;"></div>
    </div>
  </div>

  <div id="tab-telecom" class="tab-content container hidden">
    <h3>üì± Telecom Center</h3>
    <div class="card">
        <p>Buy a new SIM line for 250 EGP</p>
        <select id="company">
            <option value="">Select Operator</option>
            <option value="Orange">Orange</option>
            <option value="Vodafone">Vodafone</option>
            <option value="e&">e&</option>
        </select>
        <button onclick="buyNumber()">Purchase Line</button>
    </div>

    <div id="simApp" class="hidden">
        <div class="card" style="border-top: 4px solid #4caf50;">
            <h4>SIM Control: <span id="simCompany" style="color:var(--primary)"></span></h4>
            <p>Select a data bundle:</p>
            <button onclick="buyBundle(40, 1500)" style="font-size:0.9rem;">1.5GB / 40 EGP</button>
            <button onclick="buyBundle(60, 2250)" style="font-size:0.9rem;">2.2GB / 60 EGP</button>
            <button onclick="buyBundle(80, 4250)" style="font-size:0.9rem;">4.2GB / 80 EGP</button>
        </div>
    </div>
  </div>

  <div id="tab-social" class="tab-content container hidden">
    <h3>üåê Facenet</h3>
    <div class="card">
        <input id="postTitle" placeholder="What's on your mind?" />
        <div style="display:flex; gap: 10px; align-items:center;">
            <input id="postImage" type="file" accept="image/*,video/*" style="font-size: 0.8rem;"/>
            <button onclick="makePost()" style="width:100px;">Post</button>
        </div>
    </div>
    <div id="facenetPosts"></div>
    <button id="resetBtn" class="hidden" onclick="resetFacenet()" style="background: #600;">Reset All Posts</button>
  </div>

  <div id="tab-extras" class="tab-content container hidden">
    <h3>üßæ Bills & Services</h3>
    <div id="billList"></div>

    <div class="card">
        <h4>Manager Access</h4>
        <input id="billCode" placeholder="Secret Access Code" />
        <button onclick="unlockBillAdmin()" style="background:#333">Unlock Tools</button>
        
        <div id="addBillArea" class="hidden" style="margin-top:15px; border-top: 1px solid #444; padding-top:15px;">
            <input id="billTitle" placeholder="Bill Name" />
            <input id="billAmount" type="number" placeholder="Amount" />
            <button onclick="addBill()">Issue Bill</button>
        </div>
    </div>

    <div class="card">
        <h4>Redeem Codes</h4>
        <input id="secretMoney" placeholder="Feature Code" />
        <input id="moneyAmount" type="number" placeholder="Value" />
        <button onclick="changeMoney()" style="background:#333">Execute</button>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="showTab('dashboard', this)"><i>üè†</i>Home</div>
    <div class="nav-item" onclick="showTab('telecom', this)"><i>üì±</i>SIM</div>
    <div class="nav-item" onclick="showTab('social', this)"><i>üåç</i>Feed</div>
    <div class="nav-item" onclick="showTab('extras', this)"><i>üí≥</i>More</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// --- CORE CONFIG & STATE ---
const firebaseConfig = {
    apiKey: "AIzaSyD8LLjhoQEefz6dYdhSVbFOsIqvizO8WaY",
    authDomain: "aya-game-e579b.firebaseapp.com",
    databaseURL: "https://aya-game-e579b-default-rtdb.firebaseio.com",
    projectId: "aya-game-e579b",
    storageBucket: "aya-game-e579b.appspot.com",
    messagingSenderId: "425563173336",
    appId: "1:425563173336:web:4de74ff9fcd07d..."
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let serverOffsetMs = 0;
let soundReady = false;

// --- TAB NAVIGATION SYSTEM ---
function showTab(tabId, el) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById('tab-' + tabId).classList.remove('hidden');
    
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
}

// --- CLOCK SYSTEM ---
db.ref(".info/serverTimeOffset").on("value", snap => { serverOffsetMs = snap.val() || 0; });

function startGameClock() {
    const cycleMs = 12 * 60 * 1000; // 12 real mins = 1 virtual day
    const scale = (24 * 60 * 60 * 1000) / cycleMs;

    setInterval(() => {
        const virtualMs = ((Date.now() + serverOffsetMs) % cycleMs) * scale;
        const d = new Date(virtualMs);
        let h = d.getUTCHours();
        const m = String(d.getUTCMinutes()).padStart(2, "0");
        const ampm = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        const el = document.getElementById("gameTime");
        if (el) el.textContent = `${h}:${m} ${ampm}`;
    }, 1000);
}

// --- AUTH LOGIC ---
function login() {
    const user = document.getElementById("username").value.trim().toLowerCase();
    const pin = document.getElementById("pin").value.trim();
    const keep = document.getElementById("keepSigned").checked;
    
    if(!user || !pin) return alert("Please enter credentials");
    
    db.ref("users/" + user).once("value").then(snap => {
        if (!snap.exists()) return alert("User not found");
        if (snap.val().pin === pin) {
            currentUser = user;
            (keep ? localStorage : sessionStorage).setItem("7ayaUser", user);
            loadUser();
        } else {
            alert("Incorrect PIN");
        }
    });
}

function loadUser() {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");
    
    db.ref("users/" + currentUser).on("value", snap => {
        const data = snap.val();
        document.getElementById("money").textContent = data.money ?? 0;
        document.getElementById("phone").textContent = data.phone || "No Number";
        document.getElementById("raseed").textContent = data.raseed ?? 0;
        document.getElementById("internet").textContent = data.internet ?? 0;
        document.getElementById("welcome").textContent = `Hi, ${currentUser}`;

        if (data.company) {
            document.getElementById("simApp").classList.remove("hidden");
            document.getElementById("simCompany").textContent = data.company;
        }
        
        document.getElementById("resetBtn").classList.toggle("hidden", currentUser !== "zezo");
    });

    startGameClock();
    loadPosts();
    loadBills();
    startInternetDrain();
}

function logout() {
    localStorage.removeItem("7ayaUser");
    sessionStorage.removeItem("7ayaUser");
    location.reload();
}

// --- MONEY & QR ---
let qrCodeScanner = null;
function prepareSound() {
    const audio = document.getElementById("successSound");
    audio.play().then(() => { audio.pause(); audio.currentTime = 0; soundReady = true; }).catch(() => {});
}

function startQrMoneyTransfer() {
    const scanDiv = document.getElementById("scanner");
    scanDiv.style.display = "block";
    if (!qrCodeScanner) qrCodeScanner = new Html5Qrcode("scanner");

    Html5Qrcode.getCameras().then(devices => {
        const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        qrCodeScanner.start(backCam.id, { fps: 20, qrbox: 250 }, onQrDetected);
    });
}

function onQrDetected(qrData) {
    qrCodeScanner.stop().then(() => {
        document.getElementById("scanner").style.display = "none";
        const recipient = qrData.trim().toLowerCase();
        if (recipient === currentUser) return alert("Cannot send to yourself");

        const amount = parseInt(prompt(`Transfer amount to ${recipient}:`));
        if (isNaN(amount) || amount <= 0) return;

        db.ref("users/" + currentUser + "/money").transaction(current => {
            if ((current || 0) >= amount) {
                db.ref("users/" + recipient + "/money").transaction(rec => (rec || 0) + amount);
                if(soundReady) document.getElementById("successSound").play();
                alert(`Successfully sent ${amount} EGP`);
                return current - amount;
            } else {
                alert("Insufficient funds");
                return current;
            }
        });
    });
}

// --- UTILITY FUNCTIONS (Condensed) ---
function makeCard() {
    const pin = document.getElementById("cardPin").value.trim();
    if (pin.length !== 3) return alert("PIN must be 3 digits");
    const num = `${Math.floor(1000+Math.random()*9000)} ${Math.floor(1000+Math.random()*9000)}`;
    db.ref(`users/${currentUser}/card`).set({ pin, number: num }).then(() => alert("Card Generated!"));
}

function openCard() {
    const pin = document.getElementById("openCardPin").value.trim();
    db.ref(`users/${currentUser}/card`).once("value").then(snap => {
        const c = snap.val();
        if (c && c.pin === pin) {
            document.getElementById("cardView").innerHTML = `
                <p><b>Number:</b> ${c.number}</p>
                <p><b>Country:</b> ${c.country || 'Egypt'}</p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${currentUser}" style="width:120px;display:block;margin:10px auto;">
            `;
            document.getElementById("cardView").classList.remove("hidden");
        } else { alert("Wrong PIN"); }
    });
}

function buyNumber() {
    const company = document.getElementById("company").value;
    if(!company) return alert("Choose operator");
    db.ref("users/" + currentUser).once("value").then(snap => {
        const d = snap.val();
        if(d.money < 250) return alert("Need 250 EGP");
        db.ref("users/"+currentUser).update({
            money: d.money - 250,
            phone: "01" + Math.floor(100000000 + Math.random()*900000000),
            company: company,
            raseed: 0, internet: 0
        });
    });
}

function buyBundle(cost, mb) {
    db.ref("users/" + currentUser).once("value").then(snap => {
        const d = snap.val();
        if(d.raseed < cost) return alert("Insufficient Raseed");
        db.ref("users/"+currentUser).update({
            raseed: d.raseed - cost,
            internet: (d.internet || 0) + mb
        });
    });
}

function makePost() {
    const title = document.getElementById("postTitle").value.trim();
    const file = document.getElementById("postImage").files[0];
    if(!title || !file) return alert("Title and media required");

    const reader = new FileReader();
    reader.onload = (e) => {
        db.ref("posts").push({
            user: currentUser,
            title: title,
            url: e.target.result,
            mediaType: file.type.startsWith("video") ? "video" : "image",
            timestamp: Date.now()
        }).then(() => {
            alert("Posted!");
            document.getElementById("postTitle").value = "";
        });
    };
    reader.readAsDataURL(file);
}

function loadPosts() {
    db.ref("posts").limitToLast(20).on("value", snap => {
        const container = document.getElementById("facenetPosts");
        container.innerHTML = "";
        snap.forEach(child => {
            const p = child.val();
            const div = document.createElement("div");
            div.className = "post-card";
            const media = p.mediaType === "video" ? `<video src="${p.url}" controls></video>` : `<img src="${p.url}">`;
            div.innerHTML = `<b>@${p.user}</b><p>${p.title}</p>${media}`;
            container.prepend(div);
        });
    });
}

function startInternetDrain() {
    setInterval(() => {
        db.ref(`users/${currentUser}/internet`).transaction(val => Math.max(0, (val || 0) - 50));
    }, 60000);
}

function changeMoney() {
    const code = document.getElementById("secretMoney").value;
    const amt = parseInt(document.getElementById("moneyAmount").value);
    if(code === "555") db.ref(`users/${currentUser}/money`).set(amt);
}

function unlockBillAdmin() {
    if(document.getElementById("billCode").value === "555") 
        document.getElementById("addBillArea").classList.remove("hidden");
}

function addBill() {
    const title = document.getElementById("billTitle").value;
    const amount = parseInt(document.getElementById("billAmount").value);
    db.ref(`users/${currentUser}/bills`).push({ title, amount, paid: false }).then(() => loadBills());
}

function loadBills() {
    db.ref(`users/${currentUser}/bills`).on("value", snap => {
        const container = document.getElementById("billList");
        container.innerHTML = "";
        snap.forEach(child => {
            const b = child.val();
            const id = child.key;
            const div = document.createElement("div");
            div.className = "card";
            div.style.borderLeft = b.paid ? "4px solid green" : "4px solid red";
            div.innerHTML = `<b>${b.title}</b><br>${b.amount} EGP <br>
                ${b.paid ? '‚úÖ Paid' : `<button onclick="payBill('${id}', ${b.amount})" style="padding:5px; margin-top:5px;">Pay Now</button>`}`;
            container.appendChild(div);
        });
    });
}

function payBill(id, amt) {
    db.ref(`users/${currentUser}`).once("value").then(snap => {
        if(snap.val().money >= amt) {
            db.ref(`users/${currentUser}/money`).set(snap.val().money - amt);
            db.ref(`users/${currentUser}/bills/${id}/paid`).set(true);
        } else alert("Not enough money");
    });
}

// Check session
window.onload = () => {
    const saved = localStorage.getItem("7ayaUser") || sessionStorage.getItem("7ayaUser");
    if (saved) { currentUser = saved; loadUser(); }
};
</script>

<audio id="successSound" src="https://audio.jukehost.co.uk/1aTbUcc5vRSDBHlwrgNMrAszF5BJ3Q8J" preload="auto"></audio>

</body>
</html>
