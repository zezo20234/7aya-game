<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sim‑Card + Facenet App</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    .hidden { display: none; }
    .section { background: #fff; padding: 15px; margin: 15px 0; border-radius: 8px; }
    button { margin:5px; padding:8px 12px; }
    #posts .post { border-bottom:1px solid #ddd; padding:10px 0; }
  </style>
</head>
<body>
  <h2>SIM‑Card + Facenet App</h2>
  <div id="loginDiv" class="section">
    <input id="username" placeholder="Username">
    <input id="pin" placeholder="PIN" type="password">
    <button onclick="login()">Login</button>
  </div>

  <div id="mainDiv" class="hidden">
    <div class="section" id="info">
      <p>Money: <span id="money"></span> EGP</p>
      <p>Phone: <span id="phone"></span></p>
      <button onclick="makeCard()">Make Card</button>
      <button onclick="openCard()">Open Card</button>
      <button onclick="buyNumber()">Buy Phone Number</button>
      <button class="hidden" id="simAppBtn" onclick="openSimApp()">SIM App</button>
      <div id="cardDiv" class="hidden section">
        <h3>Your Card</h3>
        <p>Name: <span id="cardName"></span></p>
        <div id="qrcode"></div>
      </div>
    </div>

    <div id="simDiv" class="hidden section">
      <h3>SIM App</h3>
      <p>Company: <span id="simCompany"></span></p>
      <p>Number: <span id="simNumber"></span></p>
      <p>Raseed: <span id="raseed"></span> EGP</p>
      <input id="secretCode" placeholder="Enter secret code">
      <button onclick="enterSecret()">Add Raseed</button>
      <h4>Buy Internet:</h4>
      <button onclick="buyBundle(40,1500)">40 EGP → 1500 MB</button>
      <button onclick="buyBundle(50,1750)">50 EGP → 1750 MB</button>
      <button onclick="buyBundle(60,2250)">60 EGP → 2250 MB</button>
      <button onclick="buyBundle(70,2500)">70 EGP → 2500 MB</button>
      <button onclick="buyBundle(80,2750)">80 EGP → 2750 MB</button>
      <p>Internet Left: <span id="internet"></span> MB</p>
    </div>

    <div id="facenetDiv" class="hidden section">
      <h3>Facenet (Posts)</h3>
      <input id="postTitle" placeholder="Title"><br>
      <input type="file" id="postFile"><br>
      <button onclick="submitPost()">Post</button>
      <div id="posts"></div>
    </div>
  </div>

<script>
  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyD8LLjhoQEefz6dYdhSVbFOsIqvizO8WaY",
    authDomain: "aya-game-e579b.firebaseapp.com",
    databaseURL: "https://aya-game-e579b-default-rtdb.firebaseio.com",
    projectId: "aya-game-e579b",
    storageBucket: "aya-game-e579b.appspot.com",
    messagingSenderId: "609706801625",
    appId: "1:609706801625:web:1e128b6f2c001133c1c1c8",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser = null;
  let internetTimer = null;

  function login(){
    const u = document.getElementById('username').value;
    const p = document.getElementById('pin').value;
    db.ref('users/'+u).get().then(snap=>{
      const d = snap.val();
      if(d && d.pin===p){
        currentUser = u;
        document.getElementById('loginDiv').classList.add('hidden');
        document.getElementById('mainDiv').classList.remove('hidden');
        initUserData();
      } else alert('Invalid login');
    });
  }

  function initUserData(){
    const ref = db.ref('users/'+currentUser);
    ref.on('value', snap => {
      const d = snap.val();
      document.getElementById('money').innerText = d.money;
      document.getElementById('phone').innerText = d.phone || '-';
      document.getElementById('raseed').innerText = d.raseed || 0;
      document.getElementById('internet').innerText = d.internet || 0;
      document.getElementById('simAppBtn').classList.toggle('hidden', !d.phone);
      document.getElementById('simCompany').innerText = d.company || '-';
      document.getElementById('simNumber').innerText = d.phone || '-';
      toggleSimDiv();
      toggleFacenet();
    });
    startInternetDrain();
    loadPosts();
  }

  function makeCard(){
    const pin = prompt('Set 3-digit PIN');
    if(!/^\d{3}$/.test(pin)) return alert('PIN must be 3 digits');
    db.ref(`cards/${currentUser}`).set({pin});
    alert('Card created');
  }

  function openCard(){
    const pin = prompt('Enter card PIN');
    db.ref(`cards/${currentUser}`).get().then(snap =>{
      const d = snap.val();
      if(d && d.pin===pin){
        document.getElementById('cardDiv').classList.remove('hidden');
        document.getElementById('cardName').innerText = currentUser;
        const el = document.getElementById('qrcode');
        el.innerHTML='';
        QRCode.toCanvas(el, `CARD:${currentUser}:${pin}`,{width:150});
      } else alert('Wrong PIN or no card');
    });
  }

  function buyNumber(){
    const co = prompt('Choose provider: orange, vodafone, e&');
    if(!['orange','vodafone','e&'].includes(co)) return;
    db.ref('users/'+currentUser).get().then(snap=>{
      const u = snap.val();
      if(u.money<250) return alert('Not enough money');
      const num = {orange:'0101',vodafone:'0102','e&':'0103'}[co]+Math.floor(Math.random()*9000000+1000000);
      db.ref('users/'+currentUser).update({
        money: u.money-250,
        phone: num,
        company: co,
        internet: u.internet || 0
      });
    });
  }

  function openSimApp(){
    document.getElementById('simDiv').classList.toggle('hidden');
  }

  function enterSecret(){
    const code = document.getElementById('secretCode').value;
    if(code==='*#2025#'){
      db.ref('users/'+currentUser+'/raseed').transaction(r=> (r||0)+1000);
    } else alert('Wrong code');
  }

  function buyBundle(price,mb){
    db.ref('users/'+currentUser).get().then(snap=>{
      const u = snap.val();
      if((u.raseed||0) < price) return alert('Not enough raseed');
      db.ref('users/'+currentUser).update({
        raseed: u.raseed - price,
        internet: (u.internet||0)+mb
      });
    });
  }

  function startInternetDrain(){
    if(internetTimer) clearInterval(internetTimer);
    internetTimer = setInterval(()=>{
      db.ref('users/'+currentUser+'/internet').transaction(i=>{
        if(!i || i<150) return i;
        return i - 150;
      });
    }, 60000);
  }

  function toggleFacenet(){
    db.ref('users/'+currentUser+'/internet').get().then(snap=>{
      const i = snap.val() || 0;
      document.getElementById('facenetDiv').classList.toggle('hidden', i<1);
    });
  }

  function submitPost(){
    const title = document.getElementById('postTitle').value;
    const file = document.getElementById('postFile').files[0];
    if(!title||!file) return alert('Title and file required');
    const reader = new FileReader();
    reader.onload = e =>{
      const data = {
        user: currentUser,
        title,
        fileData: e.target.result,
        time: Date.now()
      };
      db.ref('posts').push(data);
      document.getElementById('postTitle').value='';
      document.getElementById('postFile').value=null;
    };
    reader.readAsDataURL(file);
  }

  function loadPosts(){
    const div = document.getElementById('posts');
    db.ref('posts').on('value', snap =>{
      div.innerHTML='';
      snap.forEach(ch=>{
        const p = ch.val();
        const el = document.createElement('div');
        el.className='post';
        el.innerHTML = `<b>${p.user}</b> – ${new Date(p.time).toLocaleString()}<br><b>${p.title}</b><br><img src="${p.fileData}" width="200">`;
        div.prepend(el);
      });
    });
  }
</script>
</body>
</html>
