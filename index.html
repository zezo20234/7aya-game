<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sibling Game</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 20px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
    .top-bar { background: #333; color: white; padding: 10px; display: flex; justify-content: space-between; }
    #dashboard, #scanner, #edit-user, #facenet, #card-container, #transfer-scanner { display: none; }
    #card-container { margin-top: 10px; }
    .real-card {
      border-radius: 15px;
      width: 320px;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: white;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-family: 'Courier New', Courier, monospace;
    }
    .real-card h3 { margin: 0; font-size: 24px; }
    .real-card small { font-size: 12px; opacity: 0.8; }
    .facenet-post {
      background: white; padding: 10px; margin: 10px 0;
      border-radius: 8px; box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<div id="login">
  <h2>Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="login-error" style="color:red;"></p>
</div>

<div id="dashboard">
  <div class="top-bar">
    <div id="user-phone">ðŸ“ž Phone: None</div>
    <div id="user-money">ðŸ’° Money: $0</div>
  </div>

  <h3>Welcome, <span id="user-name"></span></h3>
  <button onclick="makeCard()">Make Card</button>
  <button onclick="openCard()">Open Card</button>
  <div id="card-container"></div>
    <div>
    <h4>Secret Code (Change Balance)</h4>
    <input id="secret-code" placeholder="Secret Code">
    <input id="new-balance" type="number" placeholder="New Balance">
    <button onclick="changeMyBalance()">Change</button>
  </div>

  <div>
    <h4>Transfer Money</h4>
    <button onclick="startTransferScanner()">Scan QR to Send</button>
    <div id="transfer-scanner"></div>
  </div>

  <div id="admin-tools">
    <h4>Admin QR Scanner (Zezo Only)</h4>
    <button onclick="startAdminScanner()">Scan User to Edit</button>
    <div id="scanner"></div>
    <div id="edit-user">
      <h5>Edit Scanned User</h5>
      <p id="edit-username"></p>
      <input id="edit-money" type="number" placeholder="New Balance">
      <input id="edit-phone" placeholder="New Phone">
      <button onclick="saveEdit()">Save</button>
    </div>
  </div>

  <div id="facenet">
    <h3>Facenet ðŸ§ </h3>
    <input id="post-title" placeholder="Title">
    <input id="post-image" type="file">
    <button onclick="addPost()">Post</button>
    <div id="posts"></div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD8LLjhoQEefz6dYdhSVbFOsIqvizO8WaY",
  authDomain: "aya-game-e579b.firebaseapp.com",
  databaseURL: "https://aya-game-e579b-default-rtdb.firebaseio.com",
  projectId: "aya-game-e579b",
  storageBucket: "aya-game-e579b.appspot.com",
  messagingSenderId: "609706801625",
  appId: "1:609706801625:web:1e128b6f2c001133c1c1c8",
  measurementId: "G-E6BK1J3X3R"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let currentUser = null;
let scannedUser = null;

function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  db.ref("users/" + username).once("value", snapshot => {
    if (snapshot.exists() && snapshot.val().password === password) {
      currentUser = username;
      document.getElementById("login").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("user-name").innerText = username;
      if (username === "zezo") document.getElementById("admin-tools").style.display = "block";
      document.getElementById("facenet").style.display = "block";
      updateUI();
    } else {
      document.getElementById("login-error").innerText = "Wrong username or password";
    }
  });
}

function updateUI() {
  db.ref("users/" + currentUser).once("value", snap => {
    const user = snap.val();
    document.getElementById("user-phone").innerText = "ðŸ“ž Phone: " + (user.phone || "None");
    document.getElementById("user-money").innerText = "ðŸ’° Money: $" + user.money;
  });
}
  function makeCard() {
  const pin = prompt("Enter 3-digit PIN:");
  if (!/^[0-9]{3}$/.test(pin)) return alert("Invalid PIN");

  db.ref("users/" + currentUser).update({ card: { pin } });
  alert("Card created!");
  showCard();
}

function openCard() {
  db.ref("users/" + currentUser).once("value", snap => {
    const data = snap.val();
    if (!data.card) return alert("No card");
    const pin = prompt("Enter PIN:");
    if (pin === data.card.pin) showCard();
    else alert("Wrong PIN");
  });
}

function showCard() {
  db.ref("users/" + currentUser).once("value", snap => {
    const c = document.getElementById("card-container");
    c.style.display = "block";
    c.innerHTML = `
      <div class="real-card">
        <h3>${currentUser.toUpperCase()}</h3>
        <p>ðŸ’³ Virtual Card</p>
        <div id="qrcode"></div>
        <small>Scan to Transfer or Edit</small>
      </div>
    `;
    new QRCode(document.getElementById("qrcode"), currentUser);
  });
}

function changeMyBalance() {
  const code = document.getElementById("secret-code").value;
  const newBal = parseInt(document.getElementById("new-balance").value);
  if (code === "magiccode" && !isNaN(newBal)) {
    db.ref("users/" + currentUser).update({ money: newBal });
    updateUI();
    alert("Balance changed!");
  } else {
    alert("Wrong code or balance");
  }
}

function startTransferScanner() {
  const div = document.getElementById("transfer-scanner");
  div.innerHTML = "";
  div.style.display = "block";
  const qr = new Html5Qrcode("transfer-scanner");
  Html5Qrcode.getCameras().then(cams => {
    const cam = cams.find(c => c.label.toLowerCase().includes("back")) || cams[0];
    qr.start(cam.id, { fps: 10, qrbox: 250 }, msg => {
      qr.stop();
      if (msg === currentUser) return alert("You can't send to yourself.");
      db.ref("users/" + msg).once("value", snap => {
        if (!snap.exists()) return alert("User not found");
        const amount = parseInt(prompt(`Send how much to ${msg}?`));
        if (isNaN(amount) || amount <= 0) return;
        db.ref("users/" + currentUser).once("value", s1 => {
          if (s1.val().money < amount) return alert("Not enough balance");
          db.ref("users/" + currentUser).update({ money: s1.val().money - amount });
          db.ref("users/" + msg).update({ money: snap.val().money + amount });
          updateUI();
          alert("Transfer done");
        });
      });
    });
  });
}

function startAdminScanner() {
  const div = document.getElementById("scanner");
  div.innerHTML = "";
  div.style.display = "block";
  const qr = new Html5Qrcode("scanner");
  Html5Qrcode.getCameras().then(cams => {
    const cam = cams.find(c => c.label.toLowerCase().includes("back")) || cams[0];
    qr.start(cam.id, { fps: 10, qrbox: 250 }, msg => {
      qr.stop();
      db.ref("users/" + msg).once("value", snap => {
        if (!snap.exists()) return alert("User not found");
        scannedUser = msg;
        document.getElementById("edit-user").style.display = "block";
        document.getElementById("edit-username").innerText = msg;
        document.getElementById("edit-money").value = snap.val().money;
        document.getElementById("edit-phone").value = snap.val().phone;
      });
    });
  });
}

function saveEdit() {
  db.ref("users/" + scannedUser).update({
    money: parseInt(document.getElementById("edit-money").value),
    phone: document.getElementById("edit-phone").value
  });
  updateUI();
  alert("User updated!");
}

function addPost() {
  const title = document.getElementById("post-title").value;
  const file = document.getElementById("post-image").files[0];
  if (!file) return alert("Please select an image");

  const reader = new FileReader();
  reader.onload = () => {
    const url = reader.result;
    const postId = Date.now();
    db.ref("posts/" + postId).set({
      user: currentUser,
      title: title,
      image: url
    });
  };
  reader.readAsDataURL(file);
}

function loadPosts() {
  db.ref("posts").on("value", snap => {
    const div = document.getElementById("posts");
    div.innerHTML = "";
    const userInternetRef = db.ref("users/" + currentUser + "/internet");
    userInternetRef.once("value", internetSnap => {
      const internet = internetSnap.val() || 0;
      if (internet < 100) {
        div.innerHTML = "<p>You need internet to view posts.</p>";
        return;
      }
      const data = snap.val();
      for (let id in data) {
        const post = data[id];
        const p = document.createElement("div");
        p.className = "facenet-post";
        p.innerHTML = `<strong>${post.title}</strong><br><img src="${post.image}" width="100%">`;
        div.prepend(p);
      }
      db.ref("users/" + currentUser).update({ internet: internet - 100 });
    });
  });
}

setInterval(() => {
  if (!currentUser) return;
  db.ref("users/" + currentUser).once("value", snap => {
    const internet = snap.val().internet || 0;
    if (internet >= 150) {
      db.ref("users/" + currentUser).update({ internet: internet - 150 });
    }
  });
}, 90000); // every 1.5 minutes
</script>
</body>
</html>
