<!DOCTYPE html>
<html>
<head>
  <title>AYA Game</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2 id="info">Money: -- | Phone: --</h2>
  <div id="loginArea">
    <input id="username" placeholder="Username">
    <input id="pin" placeholder="PIN">
    <button onclick="login()">Login</button>
  </div>

  <div id="mainApp" style="display:none;">
    <button onclick="makeCard()">Make Card</button>
    <button onclick="openCard()">Open Card</button>
    <button onclick="buyPhone()">Buy Phone Number</button>
    <button onclick="openSim()">SIM App</button>
    <button onclick="openScanner()">Scan QR (Send)</button>

    <div id="qrcodeContainer" style="margin:10px;"></div>

    <div id="simApp" style="display:none;">
      <h3>Internet Bundles</h3>
      <div id="bundles"></div>
      <p>Raseed: <span id="raseed">0</span></p>
    </div>

    <hr>
    <h3>Facenet</h3>
    <input id="title" placeholder="Post title"><br>
    <input type="file" id="fileInput"><br>
    <button onclick="post()">Post</button>
    <div id="posts"></div>

    <hr>
    <h3>Secret Code</h3>
    <input id="secretCode"><button onclick="checkSecret()">Enter</button>
  </div>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyD8LLjhoQEefz6dYdhSVbFOsIqvizO8WaY",
    authDomain: "aya-game-e579b.firebaseapp.com",
    databaseURL: "https://aya-game-e579b-default-rtdb.firebaseio.com",
    projectId: "aya-game-e579b",
    storageBucket: "aya-game-e579b.firebasestorage.app",
    messagingSenderId: "609706801625",
    appId: "1:609706801625:web:1e128b6f2c001133c1c1c8",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser = null;

  function login() {
    const user = document.getElementById("username").value;
    const pin = document.getElementById("pin").value;
    db.ref("users/" + user).once("value", snap => {
      if (snap.exists() && snap.val().pin == pin) {
        currentUser = user;
        document.getElementById("loginArea").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        updateInfo();
        loadPosts();
        setInterval(() => {
          db.ref("users/" + currentUser).once("value", s => {
            let internet = s.val().internet || 0;
            internet = Math.max(0, internet - 150);
            db.ref("users/" + currentUser + "/internet").set(internet);
          });
        }, 60000);
      } else alert("Wrong info");
    });
  }

  function updateInfo() {
    db.ref("users/" + currentUser).on("value", snap => {
      const d = snap.val();
      document.getElementById("info").innerText = `Money: ${d.money || 0} | Phone: ${d.phone || 'None'}`;
      document.getElementById("raseed").innerText = d.raseed || 0;
    });
  }

  function makeCard() {
    const p = prompt("Set 3-digit PIN:");
    if (!p) return;
    db.ref("cards/" + currentUser).set({ pin: p });
  }

  function openCard() {
    const p = prompt("Enter PIN:");
    db.ref("cards/" + currentUser).once("value", snap => {
      if (snap.exists() && snap.val().pin == p) {
        db.ref("users/" + currentUser).once("value", s => {
          const d = s.val();
          const container = document.getElementById("qrcodeContainer");
          container.innerHTML = `<h3>${currentUser}</h3>`;
          new QRCode(container, `CARD:${currentUser}`);
        });
      } else alert("Wrong PIN");
    });
  }

  function buyPhone() {
    const company = prompt("Choose: Orange / Vodafone / e&");
    if (!company) return;
    db.ref("users/" + currentUser).once("value", snap => {
      let data = snap.val();
      if (data.money < 250) return alert("Not enough money");
      data.money -= 250;
      data.phone = company + "-" + Math.floor(1000000 + Math.random() * 8999999);
      db.ref("users/" + currentUser).set(data);
    });
  }

  function openSim() {
    document.getElementById("simApp").style.display = "block";
    const bundleDiv = document.getElementById("bundles");
    bundleDiv.innerHTML = '';
    const bundles = {
      40: 1500, 50: 1750, 60: 2250, 70: 2500, 80: 2750
    };
    for (let price in bundles) {
      const mb = bundles[price];
      let btn = document.createElement("button");
      btn.innerText = `${price} EGP = ${mb}MB`;
      btn.onclick = () => {
        db.ref("users/" + currentUser).once("value", snap => {
          const d = snap.val();
          if ((d.raseed || 0) < price) return alert("Not enough Raseed");
          d.raseed -= Number(price);
          d.internet = (d.internet || 0) + mb;
          db.ref("users/" + currentUser).set(d);
        });
      };
      bundleDiv.appendChild(btn);
    }
  }

  function post() {
    db.ref("users/" + currentUser).once("value", s => {
      if ((s.val().internet || 0) <= 0) return alert("No internet");
      const t = document.getElementById("title").value;
      const f = document.getElementById("fileInput").files[0];
      if (!t || !f) return alert("Need title & file");
      const reader = new FileReader();
      reader.onload = function(e) {
        db.ref("posts").push({ title: t, file: e.target.result, user: currentUser });
      };
      reader.readAsDataURL(f);
    });
  }

  function loadPosts() {
    db.ref("posts").on("value", snap => {
      db.ref("users/" + currentUser).once("value", s => {
        if ((s.val().internet || 0) <= 0) {
          document.getElementById("posts").innerHTML = "No internet to load posts";
          return;
        }
        const p = document.getElementById("posts");
        p.innerHTML = '';
        snap.forEach(post => {
          const d = post.val();
          let div = document.createElement("div");
          div.innerHTML = `<h4>${d.title}</h4><img src="${d.file}" width="150"><p>by ${d.user}</p>`;
          p.appendChild(div);
        });
      });
    });
  }

  function openScanner() {
    const scannerDiv = document.createElement("div");
    scannerDiv.id = "reader";
    document.body.appendChild(scannerDiv);
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 200 },
      (decoded) => {
        html5QrCode.stop();
        document.getElementById("reader").remove();
        if (decoded.startsWith("CARD:")) {
          const target = decoded.split(":")[1];
          const amount = prompt("How much to send?");
          db.ref("users/" + currentUser).once("value", s1 => {
            if (s1.val().money < amount) return alert("Not enough");
            db.ref("users/" + target).once("value", s2 => {
              db.ref("users/" + currentUser + "/money").set(s1.val().money - Number(amount));
              db.ref("users/" + target + "/money").set(s2.val().money + Number(amount));
              alert("Transfer complete");
            });
          });
        }
      });
  }

  function checkSecret() {
    const val = document.getElementById("secretCode").value;
    if (val === "555") {
      const newVal = prompt("Enter new balance:");
      db.ref("users/" + currentUser + "/money").set(Number(newVal));
    }
  }
  </script>
</body>
</html>
