<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>7AYA GAME</title>

  <link rel="apple-touch-icon" href="IMG_0383.jpeg">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="7AYA-GAME">
  <meta name="theme-color" content="#0d0d0d"/>

  <style>
    :root {
      --primary: #00c6ff;
      --secondary: #0072ff;
      --bg: #0d0d0d;
      --card-bg: #1a1a1a;
      --text: #ffffff;
      --gray: #888;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      margin: 0; padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      height: 100%; width: 100%;
      overflow-x: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      padding-bottom: 80px; 
    }

    /* Typography */
    h2, h3 { margin: 10px 0; font-weight: 600; letter-spacing: 0.5px; }
    p { margin: 5px 0; font-size: 0.95rem; color: #ddd; }

    .container { padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }
    .hidden { display: none !important; }

    /* Cards */
    .card {
      background: var(--card-bg);
      padding: 18px;
      border-radius: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      border: 1px solid #2a2a2a;
    }

    .wallet-card {
      background: linear-gradient(135deg, #1e1e1e 0%, #111 100%);
      border-left: 4px solid var(--primary);
    }

    /* Inputs & Buttons */
    input, select, button {
      font-size: 1rem;
      padding: 14px;
      margin: 8px 0;
      width: 100%;
      border-radius: 12px;
      border: none;
      outline: none;
      transition: 0.3s;
    }

    input, select {
      background: #252525;
      color: white;
      border: 1px solid #333;
    }

    button {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
    }

    button:active { transform: scale(0.96); opacity: 0.9; }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: #151515;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 1px solid #333;
      z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .nav-item {
      color: var(--gray);
      font-size: 12px;
      text-align: center;
      flex: 1;
      padding: 10px 0;
    }

    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-item i { display: block; font-size: 22px; margin-bottom: 4px; }

    /* Facenet Styling */
    #facenetPosts img, #facenetPosts video {
      width: 100%;
      border-radius: 12px;
      margin: 10px 0;
    }

    .post-card { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }

    /* QR Scanner */
    #scanner { border-radius: 15px; overflow: hidden; background: #000; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .tab-content { animation: fadeIn 0.3s ease-out; }
  </style>
</head>
<body>

<div id="login" class="container">
  <div style="text-align:center; margin-top: 60px;">
     <h1 style="color: var(--primary); margin-bottom: 5px; font-size: 3rem;">7AYA</h1>
     <p style="margin-bottom: 40px; color: var(--gray);">Premium Digital Simulator</p>
  </div>
  <div class="card">
    <h2>Login</h2>
    <input id="username" placeholder="Username" autocomplete="off" />
    <input id="pin" placeholder="PIN" type="password" maxlength="6" />
    <label style="display:flex; align-items:center; gap:10px; margin: 15px 0;">
        <input type="checkbox" id="keepSigned" style="width:20px; height:20px;"> Keep me signed in
    </label>
    <button onclick="login()">Enter 7AYA</button>
  </div>
</div>

<div id="main" class="hidden">
  
  <div class="container" style="padding-bottom: 0;">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2 id="welcome" style="font-size: 1.1rem; color: var(--primary);">Loading...</h2>
        <button onclick="logout()" style="width: auto; padding: 6px 15px; font-size: 0.7rem; background: #333;">LOGOUT</button>
    </div>
    <div class="card" style="margin-top: 10px; padding: 12px; text-align: center; border: 1px solid #333;">
        <span id="gameTime" style="font-family: monospace; font-size: 1.3rem; color: #fff; letter-spacing: 2px;">--:--:--</span>
    </div>
  </div>

  <div id="tab-dashboard" class="tab-content container">
    <div class="card wallet-card">
        <p style="color: var(--gray); text-transform: uppercase; font-size: 0.7rem; font-weight: bold; letter-spacing: 1px;">Balance</p>
        <h1 style="margin: 5px 0; font-size: 2.5rem;"><span id="money">0</span> <small style="font-size: 1rem; color: var(--gray);">EGP</small></h1>
        <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
        <p>üìû <span id="phone" style="color:#fff; font-weight: bold;">--</span></p>
        <p>üåê Internet: <span id="internet" style="color:var(--primary); font-weight: bold;">0</span> MB</p>
    </div>

    <button onclick="prepareSound(); startQrMoneyTransfer()">üí∏ Transfer Money (Scan)</button>
    <div id="scannerContainer">
        <div id="scanner" style="width: 100%; display: none;"></div>
        <div id="qrStatus" style="text-align:center; color: var(--primary); margin-top: 5px;"></div>
    </div>

    <div class="card">
        <h3>üé¥ Digital Card</h3>
        <input id="cardPin" placeholder="Setup 3-digit PIN" maxlength="3" />
        <button onclick="makeCard()" style="background: #222; border: 1px solid #444;">Issue Card</button>
        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
            <input id="openCardPin" placeholder="Enter Card PIN" maxlength="3" />
            <button onclick="openCard()">View Card Info</button>
        </div>
        <div id="cardView" class="card hidden" style="background: #111; margin-top:10px; border: 1px solid var(--primary);"></div>
    </div>
  </div>

  <div id="tab-telecom" class="tab-content container hidden">
    <h3>üì± Telecom Store</h3>
    <div class="card">
        <p>Buy a Phone Number (250 EGP)</p>
        <select id="company">
            <option value="">Select Operator</option>
            <option value="Orange">Orange</option>
            <option value="Vodafone">Vodafone</option>
            <option value="e&">e&</option>
        </select>
        <button onclick="buyNumber()">Get New Number</button>
    </div>

    <div id="simApp" class="hidden">
        <div class="card" style="border-top: 4px solid #4caf50;">
            <h4>SIM: <span id="simCompany" style="color:var(--primary)"></span></h4>
            <p style="font-size: 0.8rem; color: var(--gray);">Bundles will be deducted from your Money balance.</p>
            <button onclick="buyBundle(40, 1500)">1.5GB - 40 EGP</button>
            <button onclick="buyBundle(60, 2250)">2.2GB - 60 EGP</button>
            <button onclick="buyBundle(80, 4250)">4.2GB - 80 EGP</button>
        </div>
    </div>
  </div>

  <div id="tab-social" class="tab-content container hidden">
    <h3>üåç Facenet</h3>
    <div class="card">
        <input id="postTitle" placeholder="What's happening?" />
        <div style="display:flex; gap: 10px;">
            <input id="postImage" type="file" accept="image/*,video/*" style="font-size: 0.7rem; padding: 10px;"/>
            <button onclick="makePost()" style="width:120px;">POST</button>
        </div>
    </div>
    <div id="facenetPosts"></div>
  </div>

  <div id="tab-extras" class="tab-content container hidden">
    <h3>More Services</h3>
    <div class="card" style="text-align: center; padding: 40px 20px;">
        <p style="color: var(--gray);">More features coming soon...</p>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="showTab('dashboard', this)"><i>üè†</i>Wallet</div>
    <div class="nav-item" onclick="showTab('telecom', this)"><i>üì∂</i>SIM</div>
    <div class="nav-item" onclick="showTab('social', this)"><i>üåê</i>Social</div>
    <div class="nav-item" onclick="showTab('extras', this)"><i>‚öôÔ∏è</i>More</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// --- INITIALIZATION ---
const firebaseConfig = {
    apiKey: "AIzaSyD8LLjhoQEefz6dYdhSVbFOsIqvizO8WaY",
    authDomain: "aya-game-e579b.firebaseapp.com",
    databaseURL: "https://aya-game-e579b-default-rtdb.firebaseio.com",
    projectId: "aya-game-e579b",
    storageBucket: "aya-game-e579b.appspot.com",
    messagingSenderId: "425563173336",
    appId: "1:425563173336:web:4de74ff9fcd07d..."
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let serverOffsetMs = 0;
let soundReady = false;

// --- NAVIGATION ---
function showTab(tabId, el) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById('tab-' + tabId).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
}

// --- CLOCK ---
db.ref(".info/serverTimeOffset").on("value", snap => { serverOffsetMs = snap.val() || 0; });
function startGameClock() {
    const cycleMs = 12 * 60 * 1000; 
    const scale = (24 * 60 * 60 * 1000) / cycleMs;
    setInterval(() => {
        const virtualMs = ((Date.now() + serverOffsetMs) % cycleMs) * scale;
        const d = new Date(virtualMs);
        let h = d.getUTCHours();
        const m = String(d.getUTCMinutes()).padStart(2, "0");
        const ampm = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        document.getElementById("gameTime").textContent = `${h}:${m} ${ampm}`;
    }, 1000);
}

// --- AUTH ---
function login() {
    const user = document.getElementById("username").value.trim().toLowerCase();
    const pin = document.getElementById("pin").value.trim();
    const keep = document.getElementById("keepSigned").checked;
    if(!user || !pin) return alert("Enter credentials");
    db.ref("users/" + user).once("value").then(snap => {
        if (snap.exists() && snap.val().pin === pin) {
            currentUser = user;
            (keep ? localStorage : sessionStorage).setItem("7ayaUser", user);
            loadUser();
        } else { alert("Invalid User/PIN"); }
    });
}

function loadUser() {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");
    db.ref("users/" + currentUser).on("value", snap => {
        const data = snap.val();
        document.getElementById("money").textContent = data.money ?? 0;
        document.getElementById("phone").textContent = data.phone || "No Number";
        document.getElementById("internet").textContent = data.internet ?? 0;
        document.getElementById("welcome").textContent = `Hello, ${currentUser}`;
        if (data.company) {
            document.getElementById("simApp").classList.remove("hidden");
            document.getElementById("simCompany").textContent = data.company;
        }
    });
    startGameClock();
    loadPosts();
    setInterval(() => {
        db.ref(`users/${currentUser}/internet`).transaction(val => Math.max(0, (val || 0) - 40));
    }, 60000);
}

function logout() {
    localStorage.clear(); sessionStorage.clear(); location.reload();
}

// --- SIM LOGIC (MONEY BASED) ---
function buyNumber() {
    const company = document.getElementById("company").value;
    if(!company) return alert("Choose operator");
    db.ref("users/" + currentUser).once("value").then(snap => {
        if(snap.val().money < 250) return alert("Not enough Money (250 EGP required)");
        db.ref("users/"+currentUser).update({
            money: snap.val().money - 250,
            phone: "01" + Math.floor(100000000 + Math.random()*900000000),
            company: company,
            internet: 0
        });
    });
}

function buyBundle(cost, mb) {
    db.ref("users/" + currentUser).once("value").then(snap => {
        const d = snap.val();
        if(d.money < cost) return alert("Insufficient Money Balance");
        db.ref("users/"+currentUser).update({
            money: d.money - cost,
            internet: (d.internet || 0) + mb
        });
        alert(`Successfully purchased ${mb}MB`);
    });
}

// --- QR & TRANSFERS ---
let qrCodeScanner = null;
function prepareSound() {
    const audio = document.getElementById("successSound");
    audio.play().then(() => { audio.pause(); audio.currentTime = 0; soundReady = true; }).catch(() => {});
}

function startQrMoneyTransfer() {
    document.getElementById("scanner").style.display = "block";
    if (!qrCodeScanner) qrCodeScanner = new Html5Qrcode("scanner");
    Html5Qrcode.getCameras().then(devices => {
        const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        qrCodeScanner.start(backCam.id, { fps: 20, qrbox: 250 }, onQrDetected);
    });
}

function onQrDetected(qrData) {
    qrCodeScanner.stop().then(() => {
        document.getElementById("scanner").style.display = "none";
        const recipient = qrData.trim().toLowerCase();
        if (recipient === currentUser) return alert("Error: Self-transfer");
        const amount = parseInt(prompt(`Send EGP to ${recipient}:`));
        if (isNaN(amount) || amount <= 0) return;

        db.ref("users/" + currentUser + "/money").transaction(curr => {
            if ((curr || 0) >= amount) {
                db.ref("users/" + recipient + "/money").transaction(r => (r || 0) + amount);
                if(soundReady) document.getElementById("successSound").play();
                alert(`Sent ${amount} EGP`);
                return curr - amount;
            } else { alert("Insufficient funds"); return curr; }
        });
    });
}

// --- SOCIAL ---
function makePost() {
    const title = document.getElementById("postTitle").value.trim();
    const file = document.getElementById("postImage").files[0];
    if(!title || !file) return alert("Title and file required");
    const reader = new FileReader();
    reader.onload = (e) => {
        db.ref("posts").push({
            user: currentUser, title: title, url: e.target.result,
            mediaType: file.type.startsWith("video") ? "video" : "image",
            time: Date.now()
        }).then(() => { 
            document.getElementById("postTitle").value = ""; 
            alert("Posted to Facenet");
        });
    };
    reader.readAsDataURL(file);
}

function loadPosts() {
    db.ref("posts").limitToLast(15).on("value", snap => {
        const container = document.getElementById("facenetPosts");
        container.innerHTML = "";
        snap.forEach(child => {
            const p = child.val();
            const div = document.createElement("div");
            div.className = "post-card";
            const media = p.mediaType === "video" ? `<video src="${p.url}" controls></video>` : `<img src="${p.url}">`;
            div.innerHTML = `<strong>@${p.user}</strong><p>${p.title}</p>${media}`;
            container.prepend(div);
        });
    });
}

// --- CARD ---
function makeCard() {
    const pin = document.getElementById("cardPin").value.trim();
    if (pin.length !== 3) return alert("PIN must be 3 digits");
    const num = `${Math.floor(1000+Math.random()*9000)} ${Math.floor(1000+Math.random()*9000)}`;
    db.ref(`users/${currentUser}/card`).set({ pin, number: num }).then(() => alert("Card Active"));
}

function openCard() {
    const pin = document.getElementById("openCardPin").value.trim();
    db.ref(`users/${currentUser}/card`).once("value").then(snap => {
        const c = snap.val();
        if (c && c.pin === pin) {
            document.getElementById("cardView").innerHTML = `
                <p><b>Card No:</b> ${c.number}</p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${currentUser}" style="width:130px; margin:10px auto; display:block;">
            `;
            document.getElementById("cardView").classList.remove("hidden");
        } else { alert("Incorrect Card PIN"); }
    });
}

window.onload = () => {
    const saved = localStorage.getItem("7ayaUser") || sessionStorage.getItem("7ayaUser");
    if (saved) { currentUser = saved; loadUser(); }
};
</script>

<audio id="successSound" src="https://audio.jukehost.co.uk/1aTbUcc5vRSDBHlwrgNMrAszF5BJ3Q8J" preload="auto"></audio>

</body>
</html>
